# TiCI examples

This directory contains TiCI + TiFlash + TiCDC examples for:
- Local MinIO (`tici-tc.yaml`)
- Google Cloud Storage with service-account secret (`tici-tc-gcs.yaml`)
- Google Cloud Storage with GKE Workload Identity (`tici-tc-gcs-wi.yaml`)

## Prereqs
- A StorageClass named `standard` (or edit the YAML to your StorageClass).
- MinIO deployed in the same namespace (see below).
- The TiCI binary is located at `/tici-server` inside the TiCI image.
  If you are using a stock operator that runs `tici-server` from PATH, add
  `TICI_BIN=/tici-server` or extend `PATH` in `spec.tici.meta/worker.env`.

## Deploy MinIO (test-only)
Use the e2e MinIO manifest and create the bucket once:

```
kubectl -n <ns> apply -f ../../tests/images/e2e/minio/minio.yaml
```

Create bucket `ticidefaultbucket` (example with mc):

```
# assuming you have mc locally
mc alias set localminio http://minio-service.<ns>.svc:9000 12345678 12345678
mc mb --ignore-existing localminio/ticidefaultbucket
```

## Deploy the cluster

```
kubectl -n <ns> apply -f tici-tc.yaml
```

## Deploy with GCS (service-account secret)

1) Create a GCP service account and grant bucket permissions on `tici_test`.
For smoke test, start with `Storage Object Admin` on the bucket.

2) Create secret `gcs-sa` in your namespace.
The key name must be `credentials.json` to match `tici-tc-gcs.yaml`.

```
kubectl -n <ns> create secret generic gcs-sa --from-file=credentials.json=/path/to/your-service-account.json
```

3) Deploy:

```
kubectl -n <ns> apply -f tici-tc-gcs.yaml
```

4) Verify quick checks:

```
kubectl -n <ns> get pod | grep tici-demo-gcs
kubectl -n <ns> logs tici-demo-gcs-tici-worker-0 -c tici-worker --tail=100
kubectl -n <ns> logs tici-demo-gcs-tiflash-0 -c tiflash --tail=100
```

5) Verify objects are written:

```
gcloud storage ls gs://tici_test/tici_default_prefix/cdc
```

## Deploy with GCS (GKE Workload Identity)

1) Replace the placeholder GSA in `tici-tc-gcs-wi.yaml`:
`iam.gke.io/gcp-service-account: tici-gcs-wi@YOUR_GCP_PROJECT_ID.iam.gserviceaccount.com`
This example binds the WI ServiceAccount only to `tiflash`, `ticdc`, `tici.meta`, and `tici.worker`.

2) Ensure KSA/GSA binding and bucket IAM are configured, then deploy:

```
kubectl -n <ns> apply -f tici-tc-gcs-wi.yaml
```

## Notes
- TiFlash config is generated by the operator; this example sets
  `tici.logger.filename = /data0/logs/tici_searchlib.log` for consistency with other TiFlash logs.
- If you are running on kind/podman, ensure pod PID limits are removed
  (TasksMax/infinity) to avoid `newosproc` failures.

## Quick verification (FTS)

1) Start the cluster and wait for pods to be Ready.

2) Port-forward TiDB:
```
kubectl -n <ns> port-forward svc/tici-demo-tidb 4000:4000
```

3) Run the SQL from your host:
```
mysql --comments -h 127.0.0.1 -P 4000 -u root -e "
CREATE DATABASE IF NOT EXISTS tici_integration;
USE tici_integration;

DROP TABLE IF EXISTS t1;
DROP TABLE IF EXISTS t2;

CREATE TABLE IF NOT EXISTS t1(id varchar(10),body TEXT,PRIMARY KEY (id) CLUSTERED);
ALTER TABLE t1 ADD FULLTEXT INDEX ft_index (body) WITH PARSER standard;
INSERT INTO t1 VALUES
(1, 'This is the first test pdata, used to demonstrate the insert operation'),
(2, 'The second record contains some sample text for testing'),
(3, 'Third entry: verifying the TEXT field''s ability to store longer content'),
(4, 'Fourth data row, which can be used for subsequent query or analysis tests'),
(5, 'Fifth sample entry to complete the basic insertion example');

CREATE TABLE IF NOT EXISTS t2(id varchar(10),content TEXT,PRIMARY KEY (id) CLUSTERED);
ALTER TABLE t2 ADD FULLTEXT INDEX ft_index (content) WITH PARSER standard;
INSERT INTO t2 VALUES
(1, 'This is the first test data, used to demonstrate the insert operation'),
(2, 'The second record contains some sample text for testing'),
(3, 'Third entry: verifying the TEXT field''s ability to store longer content'),
(4, 'Fourth data row, which can be used for subsequent query or analysis tests'),
(5, 'Fifth sample entry to complete the basic insertion example');

DO SLEEP(10);
SELECT * FROM t1 WHERE fts_match_word('first', body);
SELECT * FROM t2 WHERE fts_match_word('first', content);
"
```
