# Feature Gates

<!-- toc -->
- [Release Signoff Checklist](#release-signoff-checklist)
- [Summary](#summary)
- [Motivation](#motivation)
  - [Goals](#goals)
  - [Non-Goals](#non-goals)
- [Proposal](#proposal)
  - [User Stories](#user-stories)
    - [Story 1](#story-1)
    - [Story 2](#story-2)
  - [Risks and Mitigations](#risks-and-mitigations)
- [Design Details](#design-details)
  - [CRD](#crd)
  - [Validation](#validation)
  - [Enable/Disable features](#enabledisable-features)
  - [Feature lifecycle](#feature-lifecycle)
    - [Alpha](#alpha)
  - [Test Plan](#test-plan)
  - [Feature Gate](#feature-gate)
- [Drawbacks](#drawbacks)
- [Alternatives](#alternatives)
  - [Add features into group/instance annotations](#add-features-into-groupinstance-annotations)
<!-- /toc -->

## Release Signoff Checklist

Items marked with (R) are required *prior to targeting to a release*.

- [ ] (R) This design doc has been discussed and approved
- [ ] (R) Test plan is in place
  - [ ] (R) e2e tests in kind
- [ ] (R) Graduation criteria is in place if required
- [ ] (R) User-facing documentation has been created in [pingcap/docs-tidb-operator]

## Summary

TiDB Operator needs feature gates to control new features.

## Motivation

It's important to avoid restarting TiDB clusters unexpectedly because it may influence the QoS of TiDB clusters. However, TiDB Operator has to restart pods if the generated pod's spec is changed. It's dangerous to develop and upgrade TiDB Operator.

We hope to introduce a mechanism to minimize the impact of TiDB Operator upgradation.

### Goals

- Feature gates in cluster level
- How to enable/disable a feature
- Lifecycle of feature gates

### Non-Goals

- How to ensure the upgrade of TiDB Operator won't restart pods

## Proposal

### User Stories

#### Story 1

Developers can add a new feature to avoid generated pod spec changes.

Not all fields of generated pod can be controlled by CRD, many of them are set to a default value by TiDB Operator. If developers hope to change the default value of an unmanaged pod field, pods might be restarted after upgrading TiDB Operator.

For example, developers may want to change/add an env variable of some pods.

#### Story 2

Users can enable/disable a feature to rolling update a specified tidb cluster.

### Risks and Mitigations

- Feature gates changes will always trigger a rolling update process(not always restart pods).
  - For TiDB, we have to indicate whether enable/disable a feature gate will restart TiDB pods.

## Design Details

### CRD

Add a new field feature gates into cluster.

```go
type Feature string

type ClusterSpec struct {
    // +listType=map
    // +listMapKey=name
    FeatureGates []FeatureGate `json:"featureGates,omitmepty"`
}

type FeatureGate struct {
    Name Feature `json:"name"`
}

type ClusterStatus struct {
    // +listType=map
    // +listMapKey=name
    FeatureGates []FeatureGateStatus `json:"featureGates,omitmepty"`
}

type FeatureGateStatus struct {
    Name Feature `json:"name"`
    Stage FeatureGateStage `json:"stage"`
    Restart bool `json:"restart,omitmepty"`
    // listType=set
    Components []string `json:"components,omitmepty"`
}

```

```yaml
apiVersion: core.pingcap.com/v1alpha1
kind: Cluster
spec:
  featureGates:
  - name: "ModifyVolumeAttribute"
status:
  # only show enabled features
  featureGates:
  - name: ModifyVolumeAttribute
    stage: ALPHA
  - name: StableFeature
    stage: STABLE
  - name: DisablePDReadinessProbe
    stage: ALPHA
    restart: true
    # Only change features of PD
    components:
    - PD
```

Add a new field for both Group/Instance CRD

```go
type XXXSpec struct {
    // +listType=map
    // +listMapKey=name
    Features []Feature `json:"features,omitmepty"`
}
```

```yaml
apiVersion: core.pingcap.com/v1alpha1
kind: TiKVGroup/TiKV
...
spec:
  features:
  - ModifyVolumeAttribute
  - StableFeature
```

### Validation

Use `ValidatingAdmissionPolicy` to forbid changes of `spec.features` from users.

```
request.userInfo.username == system:serviceaccount:tidb-admin:tidb-operator ||
(
  oldObject == null &&
  !has(object.spec.features)
) ||
(
  oldObject != null &&
  !has(oldObject.spec.features) &&
  !has(object.spec.features)
) ||
(
  oldObject != null &&
  has(oldObject.spec.features) &&
  oldObject.spec.features.size() == object.spec.features.size() &&
  oldObject.spec.features.all(f, f in object.spec.features)
)
```

### Enable/Disable features

1. Users change the feature gates in cluster spec.
2. The cluster controller will reconcile and update`pingcap.com/features` in group CRs.
3. Group controllers will reconile and update `pingcap.com/features` in instance CRs one by one just like rolling update.
4. Instance controllers will reconcile and update all managed subresources(such as pods) by new enabled features.

### Feature lifecycle

#### Alpha

- Default: disable
- Changable: false

### Test Plan

TBD

### Feature Gate

No feature gate

## Drawbacks

TBD

## Alternatives

### Add features into group/instance annotations

Pros:
- No need to change CRDs

Cons:
- Untyped
- Hard to validate some fields based on a feature
